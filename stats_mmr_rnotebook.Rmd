---
title: "R Notebook"
output: html_notebook
---

Loading necessary libraries
```{r}
library(tidyverse)
library(visdat)
library(missForest)
library(corrplot)
library(mice)
library(car)
library("MVA")
```

Combining two sets of data
```{r}
world_dev_ind <- read.csv("world_development_ind.csv")
health_ind <- read.csv("health_ind.csv")
merged_df <- merge(world_dev_ind,health_ind,by= "Country.Name") 
```

Add region categorical variable
```{r}
library(countrycode)
countries <- c(merged_df$Country.Name)
merged_df$region <- countrycode(sourcevar = countries,
                            origin = "country.name",
                            destination = "region")
```

Remove rows that have more than 50% missing data and columns that have more than 50% missing data.
```{r}
complete_rows_df <- merged_df[rowSums(is.na(merged_df)) < ncol(merged_df)/2, ]
skilled_health_staff <- complete_rows_df$skilled_health_staff
complete_columns_df <- complete_rows_df[, which(colMeans(!is.na(complete_rows_df)) > 0.5)]
final_df = subset(complete_columns_df, select = -c(Country.Name) )
```

```{r}
categorical <- subset(final_df, select = c(region))
non_categorical <- subset(final_df, select = -c(region))
no_missing <- non_categorical[complete.cases(non_categorical), ]
res <- cor(no_missing)
corrplot(res, type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45)

no_missing
```
```{r}
lm(formula = mmr ~ ., data = final_df)
```

Remove variables that present multicollinearity
```{r}
no_aliased_coef = subset(final_df, select = -c(prev_hiv_female,life_exp_birth))
no_controls = subset(no_aliased_coef, select = -c(region))

vif_fun <- function(df, keep_in) {
             # df: the dataset of interest
             # keep_in: the variables that should be kept in  
             highest <- c()
             while(TRUE) {
                # the rnorm() below is arbitrary as the VIF should not 
                # depend on it
                vifs <- vif(lm(rnorm(nrow(df)) ~. , data = df))
                adj_vifs <- vifs[-which(names(vifs) %in% keep_in)]
                if (max(adj_vifs) < 10) {
                     break
                }
               highest <- c(highest,names((which(adj_vifs == max(adj_vifs)))))
               cat("\n")
               cat("removed:", highest)
               cat("\n")
               df <- df[,-which(names(df) %in% highest)]

              }
            cat("\n")
            cat("final variables: \n")
            return(names(vifs))
              }

vif_fun(no_controls,keep_in = c("gdp","fertility_rate","skilled_health_staff","mmr"))
```

```{r}
df_after_vif <- subset(no_aliased_coef, select = -c(female_pop, log_perf_ind, goods_imports, comp_qual_log, goods_exports, govt_eff, consump_exp, rule_of_law, track_trace_log, infra_qual, reg_qual, customs_eff, external_health_exp, crop_prod_ind))
df_with_skilled_staff <- merge(df_after_vif, skilled_health_staff, by.x = 0, by.y = 0)
df_with_skilled_staff <- subset(df_with_skilled_staff, select = -c(Row.names))

names(df_with_skilled_staff)[names(df_with_skilled_staff) == "y"] <- "skilled_staff"
```

```{r}
vis_miss(df_with_skilled_staff)
```
Imputing missing data
```{r include=FALSE}
invisible(tempData <- mice(df_with_skilled_staff,m=5,maxit=50,meth='cart',seed=500))
data_after_mice <- complete(tempData,1)
```

```{r}
noncategorical <- subset(data_after_mice, select = -c(region))
boxplot(noncategorical, use.cols = TRUE)
```
```{r}
outliers = boxplot(data_after_mice$export_val_ind, plot=FALSE)$out
no_export_val_out <- data_after_mice[!(data_after_mice$export_val_ind %in% outliers),]

no_export_val_out$credit_bureau_transform <- sign(no_export_val_out$credit_bureau_covg)*abs(no_export_val_out$credit_bureau_covg)^(1/3)
no_credit_bureau = subset(no_export_val_out, select = -c(credit_bureau_covg))
```

```{r}
skewness <- function(v){
  answer <- 3 * (mean(v) - median(v)) / sd(v)
  return(answer)
}

noncategorical <- subset(no_credit_bureau, select = -c(region))
remove_cols <- c()
for(i in 1:ncol(noncategorical)) {       # for-loop over columns
  skew_val <- skewness(noncategorical[,i])
  if(skew_val >= 1 | skew_val <= -1){
    col_name <- colnames(noncategorical)[i]
    print(col_name)
    new_col_name <- paste(col_name, "transform",sep = "_")
    noncategorical[new_col_name] <- log(noncategorical[[col_name]])
    remove_cols <- append(remove_cols,i)
  }
}

noncategorical <- noncategorical[ -remove_cols ]
noncategorical$gdp_transform <- log(noncategorical$gdp)
remove_non_log = subset(noncategorical, select = -c(gdp))
```

Getting rid of outliers
```{r}
boxplot(remove_non_log, use.cols = TRUE, las=2)
```

```{r}
lm <- lm(mmr_transform~., data = remove_non_log)
summary(lm)
```
```{r}
boxplot(subset(completedData, select = -c(region)), use.cols = TRUE)
```


