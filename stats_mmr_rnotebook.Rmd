---
title: "R Notebook"
output: html_notebook
---

Loading necessary libraries
```{r}
library(tidyverse)
library(visdat)
library(missForest)
library(corrplot)
library(mice)
library(car)
library("MVA")

options(scipen=999)
```

Combining two sets of data
```{r}
data <- read.csv("final_data.csv")
data
```

Add region categorical variable
```{r}
library(countrycode)
countries <- c(data$Country.Name)
data$region <- countrycode(sourcevar = countries,
                            origin = "country.name",
                            destination = "region")
```

Remove rows that have more than 50% missing data.
```{r}
final_df <- data[rowSums(is.na(data)) < ncol(data)/2, ]
final_df
```

```{r}
vis_miss(final_df)
```

Imputing missing data
```{r include=FALSE}
invisible(tempData <- mice(final_df,m=5,maxit=50,meth='cart',seed=500))
data_after_mice <- complete(tempData,1)
```


```{r}
categorical <- subset(data_after_mice, select = c(region, Country.Name))
non_categorical <- subset(data_after_mice, select = -c(region, Country.Name))
res <- cor(non_categorical)
corrplot(res, type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45)
```
Remove variables that present multicollinearity
```{r}
no_controls = subset(data_after_mice, select = -c(region, Country.Name))

vif_fun <- function(df, keep_in) {
             # df: the dataset of interest
             # keep_in: the variables that should be kept in  
             highest <- c()
             while(TRUE) {
                # the rnorm() below is arbitrary as the VIF should not 
                # depend on it
                vifs <- vif(lm(rnorm(nrow(df)) ~. , data = df))
                adj_vifs <- vifs[-which(names(vifs) %in% keep_in)]
                if (max(adj_vifs) < 10) {
                     break
                }
               highest <- c(highest,names((which(adj_vifs == max(adj_vifs)))))
               cat("\n")
               cat("removed:", highest)
               cat("\n")
               df <- df[,-which(names(df) %in% highest)]

              }
            cat("\n")
            cat("final variables: \n")
            return(names(vifs))
              }

vif_fun(no_controls,keep_in = c("gdp","fertility_rate","skilled_health_staff","mmr"))
```

```{r}
noncategorical <- subset(data_after_mice, select = -c(region, Country.Name))
boxplot(noncategorical, use.cols = TRUE, las=2)
```
Remove export_val_ind outliers
```{r}
data_after_mice$gdp_transform <- log(data_after_mice$GDP)
data_after_mice$fertility_rate_transform <- log(data_after_mice$fertility_rate)
data_after_mice$mmr_transform <- log(data_after_mice$MMR)
data_after_mice$female_pop_transform <- log(data_after_mice$female_pop)
```

```{r}
boxplot(subset(data_after_mice, select = -c(region, GDP, fertility_rate, female_pop, MMR, Country.Name)), use.cols = TRUE, las=2)
```

```{r}
baseline <- lm(mmr_transform ~ region + govt_health_exp + private_health_exp, data = data_after_mice)
summary(baseline)
```

```{r}
baseline_contr_1 <- lm(mmr_transform ~ region + govt_health_exp + private_health_exp + gdp_transform + fertility_rate_transform + SAB, data = data_after_mice)
summary(baseline_contr_1)
```

```{r}
baseline_contr_2 <- lm(mmr_transform ~ region + govt_health_exp + private_health_exp + gdp_transform + fertility_rate_transform + SAB + female_pop_transform + num_physicians, data = data_after_mice)
summary(baseline_contr_2)
```
```{r}
df_health_exp_decile <- data_after_mice
df_health_exp_decile$govt_exp_decile <- ntile(data_after_mice$govt_health_exp, 10)
df_health_exp_decile
```
```{r}
df_gdp_decile <- df_health_exp_decile
df_gdp_decile$gdp_decile <- ntile(df_health_exp_decile$GDP, 10)
df_gdp_decile
```

```{r}
df_by_group <- aggregate(govt_exp_decile ~ region + gdp_decile, data=df_gdp_decile, FUN=mean)
df_by_group
```
```{r}
names(df_by_group)[3] <- "govt_exp_by_group"
```

```{r}
final_df <- merge(df_by_group,df_gdp_decile, by=c("region","gdp_decile"))
final_df$govt_exp_by_group <- log(final_df$govt_exp_by_group)
```

```{r}
final_df
```


```{r}
p <- ggplot(final_df, aes(x=govt_exp_by_group, y=mmr_transform)) + 
  geom_point(aes(colour=region)) +
  geom_smooth(method=lm, se=F, colour="black")

p + scale_color_brewer(palette = "Paired") + xlab("Log of mean Government Health Expenditure by region and GDP decile") + ylab("Log of MMR")
```

```{r}
groups_with_controls <- lm(mmr_transform ~ govt_exp_by_group + fertility_rate_transform + SAB + female_pop_transform + num_physicians, data = final_df)
summary(groups_with_controls)
```

```{r}
europe_df <- subset(final_df, region %in% c("Europe & Central Asia"))
```

```{r}
europe_reg <- lm(mmr_transform ~ govt_exp_by_group + fertility_rate_transform + SAB + female_pop_transform + num_physicians, data = europe_df)
summary(europe_reg)
```