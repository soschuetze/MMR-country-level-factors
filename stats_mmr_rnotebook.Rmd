---
title: "R Notebook"
output: html_notebook
---

Loading necessary libraries
```{r}
library(tidyverse)
library(visdat)
library(missForest)
library(corrplot)
library(mice)
library(car)
library("MVA")
```

Combining two sets of data
```{r}
data <- read.csv("final_data.csv")
data
```

Add region categorical variable
```{r}
library(countrycode)
countries <- c(data$Country.Name)
data$region <- countrycode(sourcevar = countries,
                            origin = "country.name",
                            destination = "region")
```

Remove rows that have more than 50% missing data.
```{r}
complete_rows_df <- data[rowSums(is.na(data)) < ncol(data)/2, ]
final_df = subset(complete_rows_df, select = -c(Country.Name, Time.Code, Country.Code, Time) )
final_df
```

```{r}
vis_miss(final_df)
```

Imputing missing data
```{r include=FALSE}
invisible(tempData <- mice(final_df,m=5,maxit=50,meth='cart',seed=500))
data_after_mice <- complete(tempData,1)
```


```{r}
categorical <- subset(data_after_mice, select = c(region))
non_categorical <- subset(data_after_mice, select = -c(region))
res <- cor(non_categorical)
corrplot(res, type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45)
```
Remove variables that present multicollinearity
```{r}
no_controls = subset(data_after_mice, select = -c(region))

vif_fun <- function(df, keep_in) {
             # df: the dataset of interest
             # keep_in: the variables that should be kept in  
             highest <- c()
             while(TRUE) {
                # the rnorm() below is arbitrary as the VIF should not 
                # depend on it
                vifs <- vif(lm(rnorm(nrow(df)) ~. , data = df))
                adj_vifs <- vifs[-which(names(vifs) %in% keep_in)]
                if (max(adj_vifs) < 10) {
                     break
                }
               highest <- c(highest,names((which(adj_vifs == max(adj_vifs)))))
               cat("\n")
               cat("removed:", highest)
               cat("\n")
               df <- df[,-which(names(df) %in% highest)]

              }
            cat("\n")
            cat("final variables: \n")
            return(names(vifs))
              }

vif_fun(no_controls,keep_in = c("gdp","fertility_rate","skilled_health_staff","mmr"))
```

```{r}
no_private_health_var <- subset(data_after_mice, select = -c(private_health_exp_per_cap, private_health_exp_percent))
noncategorical <- subset(no_private_health_var, select = -c(region))
boxplot(noncategorical, use.cols = TRUE, las=2)
```
Remove export_val_ind outliers
```{r}
no_private_health_var$gdp_transform <- log(no_private_health_var$gdp)
no_private_health_var$fertility_rate_transform <- log(no_private_health_var$fertility_rate)
no_private_health_var$mmr_transform <- log(no_private_health_var$mmr)
df_transform <- subset(no_private_health_var, select = -c(fertility_rate, mmr))
```

```{r}
boxplot(subset(df_transform, select = -c(region)), use.cols = TRUE, las=2)
```
```{r}
baseline <- lm(mmr_transform~ gdp_transform + skilled_health_staff + region + fertility_rate_transform, data = df_transform)
summary(baseline)
```

```{r}
lm_percent <- lm(mmr_transform~skilled_health_staff + gdp_transform + fertility_rate_transform + region + govt_health_exp_percent + oop_health_exp_percent, data = df_transform)
summary(lm_percent)
```

```{r}
par(mfrow = c(2, 2))
plot(lm)
```
```{r}
lm_per_cap <- lm(mmr_transform~skilled_health_staff + gdp_transform + fertility_rate_transform + region + govt_health_exp_per_cap + oop_per_cap, data = df_transform)
summary(lm_per_cap)
```

```{r}
anova(baseline, lm_percent)
```
```{r}
anova(baseline, lm_per_cap)
```

```{r}
df_with_deciles <- df_transform
df_with_deciles$gdp_decile <- ntile(df_transform$gdp, 10)
df_with_deciles
```

```{r}
lm_percent_decile <- lm(mmr_transform~skilled_health_staff + gdp_decile + fertility_rate_transform + region + govt_health_exp_percent + oop_health_exp_percent, data = df_with_deciles)
summary(lm_percent_decile)
```

```{r}
lm_per_cap_decile <- lm(mmr_transform~skilled_health_staff + gdp_decile + fertility_rate_transform + region + govt_health_exp_per_cap + oop_per_cap, data = df_with_deciles)
summary(lm_per_cap_decile)
```

```{r}
df_with_ratio <- df_with_deciles
df_with_ratio$health_exp_ratio <- df_with_ratio$govt_health_exp_percent/df_with_ratio$oop_health_exp_percent
```


```{r}
df_with_ratio
```
```{r}
lm_ratio <- lm(mmr_transform~skilled_health_staff + gdp_decile + fertility_rate_transform + region + health_exp_ratio, data = df_with_ratio)
summary(lm_ratio)
```
